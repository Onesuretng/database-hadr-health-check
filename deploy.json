{
    "contentVersion": "1.0.0.0",
    "parameters": {
      "workbookDisplayName": {
        "type": "string",
        "defaultValue": "HA DR Spot Check",
        "metadata": {
          "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
        }
      },
      "workbookType": {
        "type": "string",
        "defaultValue": "workbook",
        "metadata": {
          "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
        }
      },
      "workbookSourceId": {
        "type": "string",
        "defaultValue": "azure monitor",
        "metadata": {
          "description": "The id of resource instance to which the workbook will be associated"
        }
      },
      "workbookId": {
        "type": "string",
        "defaultValue": "[newGuid()]",
        "metadata": {
          "description": "The unique guid for this workbook instance"
        }
      }
    },
    "resources": [
      {
        "name": "[parameters('workbookId')]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2022-04-01",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('workbookDisplayName')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Database HA/DR Health Check\\r\\n\\r\\nThis workbook walks through the potential settings you should be looking at to have the most effective HA/DR setup for your Azure Data Services. \\r\\n\\r\\nFor explanations of the different values and conclusions please check our documentation.\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.sql/servers/databases\\\"\\r\\n| where name != \\\"master\\\"\\r\\n| extend BackupRedundancy = tostring(properties.currentBackupStorageRedundancy)\\r\\n| extend ZRSEnabled = tobool(properties.zoneRedundant)\\r\\n| extend failoverGroupEnabled = isnotempty(properties.failoverGroupId)\\r\\n| extend isGeoReplica = isnotempty(properties.secondaryType)\\r\\n| project id, location, resourceGroup, subscriptionId, BackupRedundancy, ZRSEnabled, failoverGroupEnabled, isGeoReplica\",\"size\":0,\"title\":\"SQL Azure Database\",\"noDataMessage\":\"You do not have any SQL Azure Databases\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"value::all\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"location\",\"formatter\":17},{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":false}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"BackupRedundancy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Local\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Zone\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Geo\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"disabled\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ZRSEnabled\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"2\",\"text\":\"\",\"tooltipFormat\":{\"tooltip\":\"Zone Redundancy for this Database is not Enabled\"}},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}},{\"columnMatch\":\"failoverGroupEnabled\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"representation\":\"2\",\"text\":\"\",\"tooltipFormat\":{\"tooltip\":\"A failover group is not enabled for this DB\"}},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}},{\"columnMatch\":\"isGeoReplica\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"Globe\",\"text\":\"Geo Secondary\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Normal\",\"text\":\"Primary\"}]}}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"SQL Azure DB\"},{\"columnId\":\"location\",\"label\":\"Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription\"},{\"columnId\":\"BackupRedundancy\",\"label\":\"Backup Redundancy\"},{\"columnId\":\"ZRSEnabled\",\"label\":\"Zone Redundant HA\"},{\"columnId\":\"failoverGroupEnabled\",\"label\":\"Failover Group Enabled\"},{\"columnId\":\"isGeoReplica\",\"label\":\"DB is a Geo Replica\"}]}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.sql/managedinstances\\\"\\r\\n| extend BackupRedundancy = iff(\\r\\n    tostring(properties.storageAccountType) == 'LRS', 'Local', \\r\\n    iff(\\r\\n        tostring(properties.storageAccountType) == 'ZRS', 'Zone', \\r\\n        iff(tostring(properties.storageAccountType) contains 'GRS', 'Geo', 'N/A')\\r\\n    )\\r\\n)\\r\\n| extend ZRSEnabled = tobool(properties.zoneRedundant)\\r\\n| join kind=leftouter ( \\r\\n    resources \\r\\n    | where type == \\\"microsoft.sql/managedinstances/databases\\\"\\r\\n    | extend parentdbmi = tostring(split(id, '/databases')[0])\\r\\n    | extend failoverGroupId = tostring(properties.failoverGroupId)\\r\\n    | project parentdbmi, failoverGroupId\\r\\n)\\r\\non $left.id == $right.parentdbmi\\r\\n| extend failoverGroupEnabled = isnotempty(failoverGroupId)\\r\\n| project id, location, resourceGroup, subscriptionId, BackupRedundancy, ZRSEnabled, failoverGroupEnabled\",\"size\":0,\"title\":\"SQL Managed Instance\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"value::all\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"location\",\"formatter\":17},{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":false}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"BackupRedundancy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Local\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Zone\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Geo\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"disabled\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ZRSEnabled\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"2\",\"text\":\"\",\"tooltipFormat\":{\"tooltip\":\"Zone Redundancy for this Database is not Enabled\"}},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}},{\"columnMatch\":\"failoverGroupEnabled\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"representation\":\"2\",\"text\":\"\",\"tooltipFormat\":{\"tooltip\":\"A failover group is not enabled for this DB\"}},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}},{\"columnMatch\":\"isGeoReplica\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"Globe\",\"text\":\"Geo Secondary\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Normal\",\"text\":\"Primary\"}]}}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Managed Instance\"},{\"columnId\":\"location\",\"label\":\"Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription\"},{\"columnId\":\"BackupRedundancy\",\"label\":\"Backup Redundancy\"},{\"columnId\":\"ZRSEnabled\",\"label\":\"Zone Redundant HA\"},{\"columnId\":\"failoverGroupEnabled\",\"label\":\"Failover Group Enabled\"}]}},\"name\":\"query - 0 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.documentdb/databaseaccounts\\\"\\r\\n| extend backupPolicy = tostring(properties.backupPolicy.type)\\r\\n| extend backupPolicyHealth = case(\\r\\n    backupPolicy == \\\"Periodic\\\", iff(\\r\\n        tostring(properties.backupPolicy.periodicModeProperties.backupStorageRedundancy) == \\\"Geo\\\" and toint(properties.backupPolicy.periodicModeProperties.backupIntervalInMinutes) <= 60,\\r\\n         \\\"Warning\\\", \\r\\n         \\\"Critical\\\"\\r\\n    ),\\r\\n    backupPolicy == \\\"Continuous\\\", iff(\\r\\n        tostring(properties.backupPolicy.continuousModeProperties.tier) == \\\"Continuous7Days\\\",\\r\\n         \\\"Warning\\\", \\r\\n         \\\"Healthy\\\"\\r\\n    ),\\r\\n    \\\"N/A\\\"\\r\\n)\\r\\n| extend numberOfLocations = array_length(properties.locations)\\r\\n| extend numberOfWriteLocations = array_length(properties.writeLocations)\\r\\n| extend numberOfReadLocations = array_length(properties.readLocations)\\r\\n| join (\\r\\n    resources\\r\\n    | where type == \\\"microsoft.documentdb/databaseaccounts\\\"\\r\\n    | mv-expand properties.locations\\r\\n    | summarize zoneRedundantCount = countif(tobool(properties_locations.isZoneRedundant) == true) by id\\r\\n) on id\\r\\n| extend zoneRedundantHealth = case(\\r\\n    zoneRedundantCount == 0, \\\"None\\\",\\r\\n    zoneRedundantCount < numberOfReadLocations, \\\"Some\\\",\\r\\n    zoneRedundantCount == numberOfReadLocations, \\\"All\\\",\\r\\n    \\\"None\\\"\\r\\n)\\r\\n| extend consistencyLevel = tostring(properties.consistencyPolicy.defaultConsistencyLevel) \\r\\n| extend consistencyUrl = 'https://learn.microsoft.com/en-us/azure/cosmos-db/consistency-levels'\\r\\n| project id, location, resourceGroup, subscriptionId, backupPolicy, backupPolicyHealth, numberOfLocations, numberOfReadLocations, numberOfWriteLocations, zoneRedundantHealth, consistencyLevel, consistencyUrl\",\"size\":0,\"title\":\"Cosmos DB\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"value::all\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"location\",\"formatter\":17},{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"backupPolicy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Continuous\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"warning\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"backupPolicyHealth\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Warning\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"critical\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"numberOfLocations\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"warning\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"numberOfReadLocations\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"warning\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"numberOfWriteLocations\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"warning\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"zoneRedundantHealth\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Some\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"All\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"warning\",\"text\":\"{0}{1}\"}]},\"tooltipFormat\":{\"tooltip\":\"This is considered healthy if all of your regions are set up for Zone Redundancy\"}},{\"columnMatch\":\"consistencyLevel\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"consistencyUrl\",\"linkTarget\":\"Url\"}},{\"columnMatch\":\"consistencyUrl\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Cosmos DB\"},{\"columnId\":\"location\",\"label\":\"Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription\"},{\"columnId\":\"backupPolicy\",\"label\":\"Backup Policy\"},{\"columnId\":\"backupPolicyHealth\",\"label\":\"Backup Policy Health\"},{\"columnId\":\"numberOfLocations\",\"label\":\"Total Regions\"},{\"columnId\":\"numberOfReadLocations\",\"label\":\"Read Regions\"},{\"columnId\":\"numberOfWriteLocations\",\"label\":\"Write Regions\"},{\"columnId\":\"zoneRedundantHealth\",\"label\":\"Zone Redundancy Health\"},{\"columnId\":\"consistencyLevel\",\"label\":\"Consistency Level\"}]}},\"name\":\"query - 2\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"azure monitor\"]}",
          "version": "1.0",
          "sourceId": "[parameters('workbookSourceId')]",
          "category": "[parameters('workbookType')]"
        }
      }
    ],
    "outputs": {
      "workbookId": {
        "type": "string",
        "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
      }
    },
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
  }